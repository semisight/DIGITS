# Copyright (c) 2015, NVIDIA CORPORATION.  All rights reserved.

language: python
python:
    2.7
compiler: gcc   # for Caffe
sudo: required  # for Caffe
env:
    global:
        # Make
        - NUM_THREADS=4
        # Caffe
        - WITH_CUDA=true
        - WITH_CMAKE=false
before_install:
    - export INSTALL_PREFIX=/home/travis/build/semisight/DIGITS/deps/torch/distro/install
    - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${INSTALL_PREFIX}/lib:/usr/local/lib:/usr/local/cuda/lib64
    - export PATH=/home/travis/miniconda/bin:${INSTALL_PREFIX}/bin:$PATH
install:
    # Caffe
    - pushd .
    - ./scripts/travis/install-caffe.sh $(pwd)/deps/caffe
    - popd

    # Torch
    - pushd .
    - ./scripts/travis/install-torch.sh $(pwd)/deps/torch
    - popd

    # DIGITS
    - sudo apt-get install graphviz
    # conda (fast)
    - conda install --yes gevent greenlet
    # pip (slow)
    - pip install -r requirements.txt
    - pip install -r requirements_test.txt
before_script:
    - export CAFFE_HOME=$(pwd)/deps/caffe
script:
    ./digits-test -v --with-coverage --cover-package=digits,tools,scripts
after_success:
    coveralls
